<?php
/**
 * Generated by Haxe 4.3.6
 */

namespace tink\http\containers;

use \tink\http\IncomingRequest;
use \php\_Boot\HxAnon;
use \tink\http\Container;
use \tink\core\_Future\SyncFuture;
use \tink\http\ContainerResult;
use \php\Boot;
use \tink\io\_Source\Source_Impl_;
use \tink\core\Outcome;
use \tink\http\ResponseHeaderBase;
use \tink\core\_Lazy\LazyConst;
use \tink\core\_Future\Future_Impl_;
use \tink\http\_Response\OutgoingResponseData;
use \tink\core\SignalTrigger;
use \tink\core\_Future\FutureObject;
use \tink\http\HandlerObject;

class LocalContainer implements Container {
	/**
	 * @var HandlerObject
	 */
	public $handler;
	/**
	 * @var bool
	 */
	public $running;

	/**
	 * @return void
	 */
	public function __construct () {
	}

	/**
	 * @param HandlerObject $handler
	 * 
	 * @return FutureObject
	 */
	public function run ($handler) {
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:18: lines 18-28
		$_gthis = $this;
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:19: characters 5-27
		$this->handler = $handler;
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:20: characters 5-19
		$this->running = true;
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:21: lines 21-27
		return new SyncFuture(new LazyConst(ContainerResult::Running(new HxAnon([
			"failures" => new SignalTrigger(),
			"shutdown" => function ($hard) use (&$_gthis) {
				#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:24: characters 9-24
				$_gthis->running = false;
				#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:25: characters 9-33
				return Future_Impl_::map(new SyncFuture(new LazyConst(true)), Boot::getStaticClosure(Outcome::class, 'Success'));
			},
		]))));
	}

	/**
	 * @param IncomingRequest $req
	 * 
	 * @return FutureObject
	 */
	public function serve ($req) {
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:30: lines 30-33
		if (!$this->running) {
			#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:31: characters 7-52
			$this1 = new ResponseHeaderBase(503, "Server stopped", new \Array_hx(), "HTTP/1.1");
			#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:30: lines 30-33
			return new SyncFuture(new LazyConst(new OutgoingResponseData($this1, Source_Impl_::$EMPTY)));
		}
		#/home/thehunter101/haxe/tink_http/0,10,0/src/tink/http/containers/LocalContainer.hx:34: characters 5-32
		return $this->handler->process($req);
	}
}

Boot::registerClass(LocalContainer::class, 'tink.http.containers.LocalContainer');
