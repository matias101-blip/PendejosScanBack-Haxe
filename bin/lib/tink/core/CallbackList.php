<?php
/**
 * Generated by Haxe 4.3.6
 */

namespace tink\core;

use \php\Boot;
use \tink\core\_Callback\Callback_Impl_;
use \tink\core\_Callback\ListCell;

class CallbackList extends SimpleDisposable {
	/**
	 * @var bool
	 */
	public $busy;
	/**
	 * @var ListCell[]|\Array_hx
	 */
	public $cells;
	/**
	 * @var bool
	 */
	public $destructive;
	/**
	 * @var \Closure
	 */
	public $ondrain;
	/**
	 * @var \Closure
	 */
	public $onfill;
	/**
	 * @var \Closure[]|\Array_hx
	 */
	public $queue;
	/**
	 * @var int
	 */
	public $used;

	/**
	 * @param bool $destructive
	 * 
	 * @return void
	 */
	public function __construct ($destructive = false) {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:165: lines 165-280
		if ($destructive === null) {
			$destructive = false;
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:186: characters 32-46
		$this->onfill = function () {
		};
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:185: characters 33-47
		$this->ondrain = function () {
		};
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:177: characters 41-46
		$this->busy = false;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:175: characters 15-17
		$this->queue = new \Array_hx();
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:174: characters 18-19
		$this->used = 0;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:179: lines 179-183
		$_gthis = $this;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:180: characters 5-44
		parent::__construct(function () use (&$_gthis) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:180: characters 23-43
			if (!$_gthis->busy) {
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:180: characters 34-43
				$_gthis->destroy();
			}
		});
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:181: characters 5-35
		$this->destructive = $destructive;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:182: characters 5-20
		$this->cells = new \Array_hx();
	}

	/**
	 * @param \Closure $cb
	 * 
	 * @return LinkObject
	 */
	public function add ($cb) {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:209: characters 5-30
		if ($this->disposeHandlers === null) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:209: characters 19-30
			return null;
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:210: characters 5-39
		$node = new ListCell($cb, $this);
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:211: characters 5-21
		$_this = $this->cells;
		$_this->arr[$_this->length++] = $node;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:212: characters 5-57
		if ($this->used++ === 0) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:212: characters 22-57
			$fn = $this->onfill;
			if (Callback_Impl_::$depth < 500) {
				Callback_Impl_::$depth++;
				$fn();
				Callback_Impl_::$depth--;
			} else {
				Callback_Impl_::defer($fn);
			}
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:213: characters 5-16
		return $node;
	}

	/**
	 * @return void
	 */
	public function clear () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:273: lines 273-274
		if ($this->busy) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:274: characters 7-24
			$_this = $this->queue;
			$_this->arr[$_this->length++] = Boot::getInstanceClosure($this, 'clear');
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:275: lines 275-276
		$_g = 0;
		$_g1 = $this->cells;
		while ($_g < $_g1->length) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:275: characters 10-14
			$cell = ($_g1->arr[$_g] ?? null);
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:275: lines 275-276
			++$_g;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:276: characters 7-19
			$cell->cb = null;
			$cell->list = null;
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:277: characters 5-14
		$this->resize(0);
	}

	/**
	 * @return void
	 */
	public function compact () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:248: lines 248-266
		if ($this->busy) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:248: characters 15-21
			return;
		} else if ($this->used === 0) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:250: characters 7-16
			$this->resize(0);
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:251: characters 7-14
			$fn = $this->ondrain;
			if (Callback_Impl_::$depth < 500) {
				Callback_Impl_::$depth++;
				$fn();
				Callback_Impl_::$depth--;
			} else {
				Callback_Impl_::defer($fn);
			}
		} else {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:254: characters 7-25
			$compacted = 0;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:256: characters 17-21
			$_g = 0;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:256: characters 21-33
			$_g1 = $this->cells->length;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:256: lines 256-263
			while ($_g < $_g1) {
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:256: characters 17-33
				$i = $_g++;
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:257: characters 16-24
				$_g2 = ($this->cells->arr[$i] ?? null);
				$_g3 = $_g2->list;
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:258: lines 258-262
				if ($_g2->cb !== null) {
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:259: characters 16-17
					$v = $_g2;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:260: lines 260-261
					if ($compacted !== $i) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:261: characters 15-35
						$this->cells->offsetSet($compacted, $v);
					}
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:262: characters 13-43
					if (++$compacted === $this->used) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:262: characters 38-43
						break;
					}
				}
			}
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:265: characters 7-19
			$this->resize($this->used);
		}
	}

	/**
	 * @return void
	 */
	public function destroy () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:193: lines 193-194
		$_g = 0;
		$_g1 = $this->cells;
		while ($_g < $_g1->length) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:193: characters 10-11
			$c = ($_g1->arr[$_g] ?? null);
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:193: lines 193-194
			++$_g;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:194: characters 7-16
			$c->cb = null;
			$c->list = null;
		}
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:196: characters 5-17
		$this->queue = null;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:197: characters 5-17
		$this->cells = null;
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:199: lines 199-202
		if ($this->used > 0) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:200: characters 7-15
			$this->used = 0;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:201: characters 7-14
			$fn = $this->ondrain;
			if (Callback_Impl_::$depth < 500) {
				Callback_Impl_::$depth++;
				$fn();
				Callback_Impl_::$depth--;
			} else {
				Callback_Impl_::defer($fn);
			}
		}
	}

	/**
	 * @return void
	 */
	public function drain () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:206: characters 5-41
		$fn = $this->ondrain;
		if (Callback_Impl_::$depth < 500) {
			Callback_Impl_::$depth++;
			$fn();
			Callback_Impl_::$depth--;
		} else {
			Callback_Impl_::defer($fn);
		}
	}

	/**
	 * @return int
	 */
	public function get_length () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:172: characters 7-18
		return $this->used;
	}

	/**
	 * @param mixed $data
	 * 
	 * @return void
	 */
	public function invoke ($data) {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:217: lines 217-245
		$_gthis = $this;
		if (Callback_Impl_::$depth < 500) {
			Callback_Impl_::$depth++;
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:218: lines 218-244
			if ($_gthis->disposeHandlers !== null) {
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:219: lines 219-244
				if ($_gthis->busy) {
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:220: lines 220-221
					if ($_gthis->destructive !== true) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 11-40
						$_this = $_gthis->queue;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 22-28
						$_g = $_gthis;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 34-38
						$data1 = $data;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 22-33
						$tmp = function () use (&$data1, &$_g) {
							$_g->invoke($data1);
						};
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 11-40
						$_this->arr[$_this->length++] = $tmp;
					}
				} else {
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:224: characters 9-20
					$_gthis->busy = true;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:226: lines 226-227
					if ($_gthis->destructive) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:227: characters 11-20
						$_gthis->dispose();
					}
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:229: characters 9-35
					$length = $_gthis->cells->length;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 19-23
					$_g1 = 0;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 23-29
					$_g2 = $length;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: lines 230-231
					while ($_g1 < $_g2) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 19-29
						$i = $_g1++;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:231: characters 11-32
						$_this = ($_gthis->cells->arr[$i] ?? null);
						if ($_this->list !== null) {
							($_this->cb)($data);
						}
					}
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:233: characters 9-21
					$_gthis->busy = false;
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:235: lines 235-243
					if ($_gthis->disposeHandlers === null) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:236: characters 11-20
						$_gthis->destroy();
					} else {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:238: lines 238-239
						if ($_gthis->used < $_gthis->cells->length) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:239: characters 13-22
							$_gthis->compact();
						}
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:241: lines 241-242
						if ($_gthis->queue->length > 0) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:242: characters 13-26
							$_this = $_gthis->queue;
							if ($_this->length > 0) {
								$_this->length--;
							}
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:242: characters 13-28
							\array_shift($_this->arr)();
						}
					}
				}
			}
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:217: lines 217-245
			Callback_Impl_::$depth--;
		} else {
			Callback_Impl_::defer(function () use (&$data, &$_gthis) {
				#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:218: lines 218-244
				if ($_gthis->disposeHandlers !== null) {
					#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:219: lines 219-244
					if ($_gthis->busy) {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:220: lines 220-221
						if ($_gthis->destructive !== true) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 11-40
							$_this = $_gthis->queue;
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 22-28
							$_g = $_gthis;
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 34-38
							$data1 = $data;
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 22-33
							$tmp = function () use (&$data1, &$_g) {
								$_g->invoke($data1);
							};
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:221: characters 11-40
							$_this->arr[$_this->length++] = $tmp;
						}
					} else {
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:224: characters 9-20
						$_gthis->busy = true;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:226: lines 226-227
						if ($_gthis->destructive) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:227: characters 11-20
							$_gthis->dispose();
						}
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:229: characters 9-35
						$length = $_gthis->cells->length;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 19-23
						$_g1 = 0;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 23-29
						$_g2 = $length;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: lines 230-231
						while ($_g1 < $_g2) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:230: characters 19-29
							$i = $_g1++;
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:231: characters 11-32
							$_this = ($_gthis->cells->arr[$i] ?? null);
							if ($_this->list !== null) {
								($_this->cb)($data);
							}
						}
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:233: characters 9-21
						$_gthis->busy = false;
						#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:235: lines 235-243
						if ($_gthis->disposeHandlers === null) {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:236: characters 11-20
							$_gthis->destroy();
						} else {
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:238: lines 238-239
							if ($_gthis->used < $_gthis->cells->length) {
								#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:239: characters 13-22
								$_gthis->compact();
							}
							#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:241: lines 241-242
							if ($_gthis->queue->length > 0) {
								#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:242: characters 13-26
								$_this = $_gthis->queue;
								if ($_this->length > 0) {
									$_this->length--;
								}
								#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:242: characters 13-28
								\array_shift($_this->arr)();
							}
						}
					}
				}
			});
		}
	}

	/**
	 * @return void
	 */
	public function release () {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:189: lines 189-190
		if (--$this->used <= ($this->cells->length >> 1)) {
			#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:190: characters 7-16
			$this->compact();
		}
	}

	/**
	 * @param int $length
	 * 
	 * @return void
	 */
	public function resize ($length) {
		#/home/thehunter101/haxe/tink_core/2,1,1/src/tink/core/Callback.hx:269: characters 5-25
		$this->cells->resize($length);
	}
}

Boot::registerClass(CallbackList::class, 'tink.core.CallbackList');
Boot::registerGetters('tink\\core\\CallbackList', [
	'length' => true
]);
